def dockerImageServer
def dockerImageClient

pipeline {
    agent any

    triggers {
        pollSCM('H/5 * * * *')
    }

    environment {
       
        DOCKERHUB_CREDENTIALS_ID = 'dockerhub-creds'
        
        // Vos noms d'images
        IMAGE_NAME_SERVER = 'hibaaguir/mern-server'
        IMAGE_NAME_CLIENT = 'hibaaguir/mern-client'

        
        DOCKER_HOST = 'tcp://localhost:2375'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

      
        stage('Build Server Image') {
           
            when {
                changeset "server/**"
            }
            steps {
                dir('server') {
                    script {
                        dockerImageServer = docker.build("${IMAGE_NAME_SERVER}:latest")
                    }
                }
            }
        }

        stage('Scan Server Image') {
            when {
                changeset "server/**"
            }
            steps {
                script {
                  
                    try {
                        bat """
                        docker run --rm -v //./pipe/docker_engine://./pipe/docker_engine aquasec/trivy:latest image --exit-code 0 --severity LOW,MEDIUM,HIGH,CRITICAL ${IMAGE_NAME_SERVER}:latest
                        """
                    } catch (Exception e) {
                        echo "Le scan Trivy a échoué (problème fréquent sur Windows). Le pipeline continue."
                    }
                }
            }
        }

        stage('Push Server Image') {
            when {
                changeset "server/**"
            }
            steps {
                script {
                    docker.withRegistry('', DOCKERHUB_CREDENTIALS_ID) {
                        dockerImageServer.push('latest')
                    }
                }
            }
        }

       
        stage('Build Client Image') {
            when {
                changeset "client/**"
            }
            steps {
                dir('client') { 
                    script {
                        dockerImageClient = docker.build("${IMAGE_NAME_CLIENT}:latest")
                    }
                }
            }
        }

        stage('Scan Client Image') {
            when {
                changeset "client/**"
            }
            steps {
                script {
                    try {
                        bat """
                        docker run --rm -v //./pipe/docker_engine://./pipe/docker_engine aquasec/trivy:latest image --exit-code 0 --severity LOW,MEDIUM,HIGH,CRITICAL ${IMAGE_NAME_CLIENT}:latest
                        """
                    } catch (Exception e) {
                        echo "Le scan Trivy a échoué. Le pipeline continue."
                    }
                }
            }
        }

        stage('Push Client Image') {
            when {
                changeset "client/**"
            }
            steps {
                script {
                    docker.withRegistry('', DOCKERHUB_CREDENTIALS_ID) {
                        dockerImageClient.push('latest')
                    }
                }
            }
        }
    }

   
    post {
        always {
            echo "Nettoyage..."
            
           
            bat "docker container prune -f"
            bat "docker image prune -f"

           
            script {
                try {
                     bat """
                     for /f "tokens=3" %%i in ('docker images ^| findstr "mern-server"') do docker rmi -f %%i
                     for /f "tokens=3" %%i in ('docker images ^| findstr "mern-client"') do docker rmi -f %%i
                     """
                } catch (Exception e) {
                    echo "Rien à nettoyer ou erreur lors du nettoyage spécifique."
                }
            }
            echo "Nettoyage terminé."
        }
    }
}
